{% extends "layout.html" %}

{% block title %}Manage Server {{ server.name }} - {{ panel_name }}{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/xterm/3.14.5/xterm.min.css"
    integrity="sha512-i20iz6Yv4k3f/XoBb3qFpw19/yIuX96USVpV/C53535q4S/XvkE01rtO5J5+F28O8vlwY8zOX+5343d6+1QO6g=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/xterm/3.14.5/xterm.min.js"
    integrity="sha512-2uLNge2+rAG5PrUSN5PjU9ADq6ngh9V2d9d1Y3vbT/74O19Tlg3uMZw4Yy6DQi9Xy/cjoGKiHw0c1Q5+5h5z5g=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xterm/3.14.5/addons/fit/fit.min.js"
    integrity="sha512-An/uK8FV8W416V1v27Z5J9E54cp7ykO6vC94jk2xZzKb5vPb5M9Yt8IvmdT7dm6wK6tQOA3cKTDjFx8W82ySg=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="/public/assets/js/console.js"></script>
<script src="/public/assets/js/server-controls.js"></script>
{% endblock %}

{% block header %}
<div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
    <div style="display: flex; align-items: center; gap: 1rem;">
        <a href="/servers"
            style="color: #6c757d; text-decoration: none; display: flex; align-items: center; font-size: 0.9em;">
            <span style="font-size: 1.2em; margin-right: 0.3rem;">‚Üê</span> Back
        </a>
        <span>{{ server.name }}</span>
        {% if server.status == "running" %}
        <span
            style="font-size: 0.5em; vertical-align: middle; margin-left: 0.5rem; padding: 0.25rem 0.5rem; border-radius: 0.25rem; background: #d4edda; color: #155724;">{{
            server.status }}</span>
        {% else %}
        <span
            style="font-size: 0.5em; vertical-align: middle; margin-left: 0.5rem; padding: 0.25rem 0.5rem; border-radius: 0.25rem; background: #fff3cd; color: #856404;">{{
            server.status }}</span>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block content %}
<div style="display: grid; grid-template-columns: 280px 1fr; gap: 2rem;">
    <!-- Sidebar -->
    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
        <!-- Stats Cards -->
        <div id="server-stats" style="display: flex; flex-direction: column; gap: 1rem;">
            <!-- CPU -->
            <div
                style="background: #2b2b2b; color: white; padding: 1.25rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="color: #aaa; font-size: 0.8rem; font-weight: 600; text-transform: uppercase;">CPU
                        Usage</span>
                    <span style="font-size: 1.2rem; font-weight: bold; color: #4ade80;" id="stat-cpu">0.0%</span>
                </div>
                <div style="height: 6px; background: #444; border-radius: 3px; overflow: hidden;">
                    <div id="stat-cpu-bar"
                        style="width: 0%; height: 100%; background: #4ade80; transition: width 0.3s ease;"></div>
                </div>
            </div>

            <!-- RAM -->
            <div
                style="background: #2b2b2b; color: white; padding: 1.25rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
                <div style="margin-bottom: 0.5rem;">
                    <span
                        style="color: #aaa; font-size: 0.8rem; font-weight: 600; text-transform: uppercase;">Memory</span>
                </div>
                <div style="font-size: 1.1rem; font-weight: bold; margin-bottom: 0.5rem;" id="stat-ram">0 MB / 0 MB
                </div>
                <div style="height: 6px; background: #444; border-radius: 3px; overflow: hidden;">
                    <div id="stat-ram-bar"
                        style="width: 0%; height: 100%; background: #3b82f6; transition: width 0.3s ease;"></div>
                </div>
            </div>

            <!-- Network -->
            <div
                style="background: #2b2b2b; color: white; padding: 1.25rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
                <div style="margin-bottom: 0.5rem;">
                    <span style="color: #aaa; font-size: 0.8rem; font-weight: 600; text-transform: uppercase;">Network
                        I/O</span>
                </div>
                <div style="font-size: 0.9rem; display: flex; flex-direction: column; gap: 0.25rem;" id="stat-network">
                    <span>‚Üì 0 B/s</span>
                    <span>‚Üë 0 B/s</span>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden;">
            <div style="padding: 1rem; border-bottom: 1px solid #eee; font-weight: bold; color: #333;">Controls</div>
            <div style="padding: 1rem; display: flex; flex-direction: column; gap: 0.75rem;">
                <button onclick="YunexalServer.sendAction('{{ server.id }}', 'start')"
                    style="background: #10b981; color: white; border: none; padding: 0.75rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: opacity 0.2s;">Start</button>
                <button onclick="YunexalServer.sendAction('{{ server.id }}', 'restart')"
                    style="background: #f59e0b; color: white; border: none; padding: 0.75rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: opacity 0.2s;">Restart</button>
                <button onclick="YunexalServer.sendAction('{{ server.id }}', 'stop')"
                    style="background: #ef4444; color: white; border: none; padding: 0.75rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: opacity 0.2s;">Stop</button>
            </div>
        </div>

        <!-- Details -->
        <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden;">
            <div style="padding: 1rem; border-bottom: 1px solid #eee; font-weight: bold; color: #333;">Server Details
            </div>
            <div style="padding: 1rem; font-size: 0.85rem; color: #555;">
                <div style="margin-bottom: 0.75rem;">
                    <div
                        style="color: #999; font-weight: 600; text-transform: uppercase; font-size: 0.7rem; margin-bottom: 0.25rem;">
                        UUID</div>
                    <code
                        style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: monospace;">{{ server.short_id() }}</code>
                </div>
                <div style="margin-bottom: 0.75rem;">
                    <div
                        style="color: #999; font-weight: 600; text-transform: uppercase; font-size: 0.7rem; margin-bottom: 0.25rem;">
                        Node</div>
                    <div style="font-weight: 500;">{{ node.name }} ({{ node.ip }})</div>
                </div>
                <div>
                    <div
                        style="color: #999; font-weight: 600; text-transform: uppercase; font-size: 0.7rem; margin-bottom: 0.25rem;">
                        Docker Image</div>
                    <div style="word-break: break-all; opacity: 0.8;">{{ server.docker_image }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Terminal -->
    <div
        style="display: flex; flex-direction: column; gap: 1rem; background: #1e1e1e; border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); overflow: hidden;">
        <style>
            .status-indicator {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                background: #f59e0b;
            }

            .status-indicator.running {
                background: #4ade80;
            }
        </style>
        <div
            style="padding: 1rem 1.5rem; background: #2d2d2d; border-bottom: 1px solid #3d3d3d; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div class='status-indicator {% if server.status == "running" %}running{% endif %}'></div>
                <span style="color: #eee; font-weight: 600; font-family: 'Inter', sans-serif;">Console</span>
            </div>
            <span style="color: #888; font-size: 0.8rem; font-family: monospace;">{{ server.id }}</span>
        </div>

        <div id="terminal-container" data-server-id="{{ server.id }}" data-node-ip="{{ node.ip }}"
            data-node-port="{{ node.port }}" data-server-status="{{ server.status }}"
            style="flex-grow: 1; min-height: 450px; padding: 0.5rem;">
            <!-- xterm.js will mount here -->
        </div>

        <div style="padding: 1rem; background: #252525; border-top: 1px solid #333;">
            <div
                style="display: flex; gap: 0.75rem; background: #1a1a1a; padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid #444;">
                <span style="color: #666; font-family: monospace;">$</span>
                <input type="text" id="console-input" placeholder="Type a command..."
                    style="background: transparent; border: none; color: #ddd; flex-grow: 1; outline: none; font-family: monospace; font-size: 0.9rem;">
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const container = document.getElementById('terminal-container');
        const serverId = container.getAttribute('data-server-id');
        const nodeIp = container.getAttribute('data-node-ip');
        const nodePort = parseInt(container.getAttribute('data-node-port'));
        const serverStatus = container.getAttribute('data-server-status');

        // Initialize Stats Polling
        if (window.YunexalServer) {
            YunexalServer.startStatsPolling(serverId);
        }

        // Initialize Console
        if (serverStatus === 'running' && window.YunexalConsole) {
            window.YunexalConsole.init(serverId, nodeIp, nodePort, 'terminal-container');

            // Console Input Handling
            const consoleInput = document.getElementById('console-input');
            consoleInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    const command = this.value;
                    if (command.trim() && window.YunexalConsole.sendMessage) {
                        window.YunexalConsole.sendMessage(command + '\n');
                        this.value = '';
                    }
                }
            });
        } else if (serverStatus !== 'running') {
            container.innerHTML = '<div style="height: 100%; display: flex; align-items: center; justify-content: center; color: #666; font-family: sans-serif; flex-direction: column; gap: 1rem;">' +
                '<div style="font-size: 3rem; opacity: 0.5;">üí§</div>' +
                '<div>Server is offline. Start it to see the console.</div></div>';
        }
    });
</script>
{% endblock %}